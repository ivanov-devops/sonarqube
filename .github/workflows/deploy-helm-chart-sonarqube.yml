name: Deploy SonarQube

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed

jobs:
  wait-for-pages-build:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for pages-build-deployment workflow to complete
        id: wait
        uses: actions/github-script@v5
        with:
          script: |
            const response = await octokit.actions.getWorkflowRun({
              owner: 'ivanov-devops',
              repo: 'sonarqube',
              run_id: 5697516146 // Replace with the actual run ID of pages-build-deployment workflow
            });
            console.log(`pages-build-deployment workflow outcome: ${response.data.conclusion}`);
            return response.data.conclusion;
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: wait-for-pages-build
    runs-on: ubuntu-latest

    steps:
      - name: Set up Kubernetes
        run: |
          mkdir ${HOME}/.kube
          echo ${{ secrets.KUBE_CONFIG }} | base64 --decode > ${HOME}/.kube/config
          chmod 600 ${HOME}/.kube/config
          cat ${HOME}/.kube/config

      - name: Install Helm Chart
        run: |
          helm repo add sonarqube https://ivanov-devops.github.io/sonarqube/
          helm repo update
          kubectl create namespace sonarqube-dce --dry-run=client -o yaml | kubectl apply -f -
          export JWT_SECRET=${{ secrets.JWT_SECRET }}
          helm upgrade --install -n sonarqube-dce sonarqube sonarqube/sonarqube-dce --set ApplicationNodes.jwtSecret=$JWT_SECRET
        env:
          KUBECONFIG: ${{ secrets.KUBE_CONFIG }}
